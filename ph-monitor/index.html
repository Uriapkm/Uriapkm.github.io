<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>pH Monitor - Web Serial Application</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/plotly.js/3.0.3/plotly.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --bg-primary: #ffffff;
            --bg-secondary: #f8f9fa;
            --bg-card: white;
            --text-primary: #212121;
            --text-secondary: #837E7E;
            --accent-blue: #4a90e2;
            --accent-green: #00c853;
            --accent-orange: #ff6d00;
            --accent-red: #d50000;
            --border-color: #e5e7eb;
        }

        [data-theme="dark"] {
            --bg-primary: #121212;
            --bg-secondary: #1a1a1a;
            --bg-card: #1E1E1E;
            --text-primary: #ffffff;
            --text-secondary: #B0BEC5;
            --accent-blue: #2962ff;
            --accent-green: #00c853;
            --accent-orange: #ff6d00;
            --accent-red: #d50000;
            --border-color: #374151;
        }

        body {
            background-color: var(--bg-primary);
            color: var(--text-primary);
            transition: all 0.3s ease;
        }

        .card {
            background-color: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .btn-primary {
            background-color: var(--accent-blue);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background-color: var(--bg-secondary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-secondary:hover {
            background-color: var(--border-color);
        }

        .btn-secondary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }

        .status-disconnected { background-color: var(--accent-red); }
        .status-connected { background-color: var(--accent-green); }
        .status-connecting { background-color: var(--accent-orange); animation: pulse 2s infinite; }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .ph-display {
            font-size: 4rem;
            font-weight: bold;
            color: var(--accent-blue);
            line-height: 1;
        }

        .tab-button {
            padding: 12px 24px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }

        .tab-button.active {
            color: var(--accent-blue);
            border-bottom-color: var(--accent-blue);
            background-color: var(--bg-secondary);
        }

        .tab-button:hover:not(.active) {
            color: var(--text-primary);
            background-color: var(--bg-secondary);
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.3s ease-in;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .input-field {
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 12px;
            border-radius: 8px;
            width: 100%;
            transition: border-color 0.2s;
        }

        .input-field:focus {
            outline: none;
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.1);
        }

        .data-table {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: 8px;
        }

        .data-table table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th,
        .data-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        .data-table th {
            background-color: var(--bg-secondary);
            font-weight: 600;
            position: sticky;
            top: 0;
        }

        .data-table tr:hover {
            background-color: var(--bg-secondary);
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 16px 24px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            z-index: 1000;
            animation: slideIn 0.3s ease-out;
        }

        .notification.success { background-color: var(--accent-green); }
        .notification.error { background-color: var(--accent-red); }
        .notification.warning { background-color: var(--accent-orange); }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .theme-toggle {
            background: none;
            border: none;
            color: var(--text-primary);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            transition: background-color 0.2s;
        }

        .theme-toggle:hover {
            background-color: var(--bg-secondary);
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="border-b border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-900">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center space-x-4">
                    <i class="fas fa-flask text-2xl text-blue-500"></i>
                    <h1 class="text-2xl font-bold">pH Monitor</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="flex items-center">
                        <span class="status-indicator status-disconnected" id="statusIndicator"></span>
                        <span id="statusText">Disconnected</span>
                    </div>
                    <button class="theme-toggle" id="themeToggle" title="Toggle theme">
                        <i class="fas fa-moon"></i>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Tab Navigation -->
        <div class="border-b border-gray-200 dark:border-gray-700 mb-8">
            <nav class="flex space-x-8">
                <button class="tab-button active" data-tab="connection">
                    <i class="fas fa-plug mr-2"></i>Connection
                </button>
                <button class="tab-button" data-tab="monitor">
                    <i class="fas fa-chart-line mr-2"></i>Monitor
                </button>
                <button class="tab-button" data-tab="calibration">
                    <i class="fas fa-tools mr-2"></i>Calibration
                </button>
                <button class="tab-button" data-tab="data">
                    <i class="fas fa-table mr-2"></i>Data
                </button>
            </nav>
        </div>

        <!-- Connection Tab -->
        <div id="connection" class="tab-content active">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- Connection Status -->
                <div class="card p-6">
                    <h2 class="text-xl font-semibold mb-4 flex items-center">
                        <i class="fas fa-info-circle mr-2 text-blue-500"></i>
                        Connection Status
                    </h2>
                    <div class="space-y-4">
                        <div class="flex items-center justify-between p-4 bg-gray-50 dark:bg-gray-800 rounded-lg">
                            <span class="font-medium">Serial Port</span>
                            <select id="portSelect" class="input-field max-w-xs">
                                <option value="">Select a port...</option>
                            </select>
                        </div>
                        <div class="flex space-x-4">
                            <button id="connectBtn" class="btn-primary flex-1">
                                <i class="fas fa-link mr-2"></i>Connect
                            </button>
                            <button id="disconnectBtn" class="btn-secondary flex-1" disabled>
                                <i class="fas fa-unlink mr-2"></i>Disconnect
                            </button>
                            <button id="refreshPortsBtn" class="btn-secondary">
                                <i class="fas fa-sync-alt mr-2"></i>Refresh
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Arduino Code -->
                <div class="card p-6">
                    <h2 class="text-xl font-semibold mb-4 flex items-center">
                        <i class="fas fa-code mr-2 text-green-500"></i>
                        Arduino Code
                    </h2>
                    <div class="bg-gray-900 text-green-400 p-4 rounded-lg font-mono text-sm overflow-x-auto">
                        <pre><code>#include <EEPROM.h>

const int pHPin = A0;           // Salida analógica del medidor de pH
const float samplingInterval = 1000; // ms

// Direcciones EEPROM
const int EEPROM_pH4_ADDR = 0;
const int EEPROM_pH7_ADDR = 4;

// Valores de calibración por defecto
float pH4Voltage = 3.018;
float pH7Voltage = 2.636;

String inputString = "";

void setup() {
    Serial.begin(9600);
    analogReference(DEFAULT);   // Asegura referencia de 5 V
    inputString.reserve(20);
    loadCalibrationData();
    Serial.println(F("pH Meter Ready"));
}

void loop() {
    // Lectura de comandos
    while (Serial.available()) {
        char c = (char)Serial.read();
        if (c == '\n' || c == '\r') {
            if (inputString.length() > 0) {
                processCommand(inputString);
                inputString = "";
            }
        } else {
            inputString += c;
        }
    }

    // Lectura periódica
    static unsigned long lastSample = 0;
    if (millis() - lastSample >= samplingInterval) {
        lastSample = millis();
        float pHValue = readpH();
        Serial.print(F("PH:"));
        Serial.println(pHValue, 2);
    }
}

float readpH() {
    float voltage = 0;
    for (int i = 0; i < 10; i++) {
        voltage += analogRead(pHPin) * (5.0 / 1023.0);
        delay(10);
    }
    voltage /= 10.0;

    // Conversión lineal con calibración a dos puntos
    float slope = (7.0 - 4.0) / (pH7Voltage - pH4Voltage);
    float intercept = 7.0 - (slope * pH7Voltage);
    return slope * voltage + intercept;
}

void processCommand(String command) {
    command.trim();
    command.toUpperCase();

    if (command.startsWith("CAL")) {
        int commaIndex = command.indexOf(',');
        if (commaIndex != -1) {
            String phValue = command.substring(commaIndex + 1);
            startCalibration(phValue.toFloat());
        }
    }
    else if (command == "READ") {
        Serial.print(F("Current pH: "));
        Serial.println(readpH(), 2);
    }
    else if (command == "RESET") {
        resetCalibration();
        Serial.println(F("Calibration reset to defaults"));
    }
}

void startCalibration(float targetPH) {
    if (targetPH != 4.0 && targetPH != 7.0) {
        Serial.println(F("Error: use pH 4.0 or 7.0"));
        return;
    }

    Serial.print(F("Calibrating pH "));
    Serial.println(targetPH);
    Serial.println(F("Place probe and wait..."));

    delay(2000);

    float voltage = 0;
    for (int i = 0; i < 20; i++) {
        voltage += analogRead(pHPin) * (5.0 / 1023.0);
        delay(200);
    }
    voltage /= 20.0;

    if (targetPH == 4.0) {
        pH4Voltage = voltage;
        EEPROM_writeFloat(EEPROM_pH4_ADDR, voltage);
    } else {
        pH7Voltage = voltage;
        EEPROM_writeFloat(EEPROM_pH7_ADDR, voltage);
    }

    Serial.println(F("Calibration complete!"));
    Serial.print(F("Voltage at pH "));
    Serial.print(targetPH);
    Serial.print(F(": "));
    Serial.println(voltage, 3);
}

void loadCalibrationData() {
    float pH4 = EEPROM_readFloat(EEPROM_pH4_ADDR);
    float pH7 = EEPROM_readFloat(EEPROM_pH7_ADDR);
    if (pH4 > 0 && pH4 < 5) pH4Voltage = pH4;
    if (pH7 > 0 && pH7 < 5) pH7Voltage = pH7;
}

void resetCalibration() {
    pH4Voltage = 3.018;
    pH7Voltage = 2.636;
    EEPROM_writeFloat(EEPROM_pH4_ADDR, pH4Voltage);
    EEPROM_writeFloat(EEPROM_pH7_ADDR, pH7Voltage);
}

void EEPROM_writeFloat(int addr, float val) {
    byte* p = (byte*)&val;
    for (int i = 0; i < 4; i++) EEPROM.write(addr + i, p[i]);
}

float EEPROM_readFloat(int addr) {
    float val;
    byte* p = (byte*)&val;
    for (int i = 0; i < 4; i++) p[i] = EEPROM.read(addr + i);
    return val;
}</code></pre>
                    </div>
                    <button id="copyCodeBtn" class="btn-secondary mt-4 w-full">
                        <i class="fas fa-copy mr-2"></i>Copy Code
                    </button>
                </div>
            </div>
        </div>

        <!-- Monitor Tab -->
        <div id="monitor" class="tab-content">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- Current Reading -->
                <div class="card p-6">
                    <h2 class="text-xl font-semibold mb-4">Current Reading</h2>
                    <div class="text-center">
                        <div class="ph-display" id="currentPH">--</div>
                        <div class="text-2xl font-semibold text-gray-600 dark:text-gray-400 mb-4">pH</div>
                        <div class="text-sm text-gray-500 dark:text-gray-400" id="readingStatus">
                            Waiting for data...
                        </div>
                        <div class="mt-4 p-3 bg-gray-50 dark:bg-gray-800 rounded-lg">
                            <div class="text-sm text-gray-600 dark:text-gray-400">Raw pH Value</div>
                            <div class="text-lg font-semibold" id="rawPH">--</div>
                        </div>
                    </div>
                </div>

                <!-- Logging Controls -->
                <div class="card p-6">
                    <h2 class="text-xl font-semibold mb-4">Data Logging</h2>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium mb-2">Interval (seconds)</label>
                            <input type="number" id="intervalInput" class="input-field" value="10" min="1" step="0.1">
                        </div>
                        <div class="flex space-x-2">
                            <button id="startLoggingBtn" class="btn-primary flex-1" disabled>
                                <i class="fas fa-play mr-2"></i>Start
                            </button>
                            <button id="stopLoggingBtn" class="btn-secondary flex-1" disabled>
                                <i class="fas fa-stop mr-2"></i>Stop
                            </button>
                        </div>
                        <div class="text-sm text-gray-500 dark:text-gray-400">
                            <div>Status: <span id="loggingStatus">Stopped</span></div>
                            <div>Measurements: <span id="measurementCount">0</span></div>
                        </div>
                    </div>
                </div>

                <!-- Statistics -->
                <div class="card p-6">
                    <h2 class="text-xl font-semibold mb-4">Statistics</h2>
                    <div class="space-y-3">
                        <div class="flex justify-between">
                            <span class="text-gray-600 dark:text-gray-400">Average pH:</span>
                            <span class="font-semibold" id="avgPH">--</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600 dark:text-gray-400">Minimum pH:</span>
                            <span class="font-semibold" id="minPH">--</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600 dark:text-gray-400">Maximum pH:</span>
                            <span class="font-semibold" id="maxPH">--</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600 dark:text-gray-400">pH Range:</span>
                            <span class="font-semibold" id="phRange">--</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600 dark:text-gray-400">Duration:</span>
                            <span class="font-semibold" id="duration">0.0s</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Graph -->
            <div class="card p-6 mt-8">
                <h2 class="text-xl font-semibold mb-4">pH vs Time Graph</h2>
                <div id="phChart" style="height: 400px;"></div>
            </div>
        </div>

        <!-- Calibration Tab -->
        <div id="calibration" class="tab-content">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- Calibration Controls -->
                <div class="card p-6">
                    <h2 class="text-xl font-semibold mb-4">Calibration Points</h2>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium mb-2">Measured pH Value</label>
                            <input type="number" id="measuredPH" class="input-field" step="0.01" min="0" max="14">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Actual pH Value</label>
                            <input type="number" id="actualPH" class="input-field" step="0.01" min="0" max="14">
                        </div>
                        <div class="flex space-x-2">
                            <button id="addCalPointBtn" class="btn-primary flex-1" disabled>
                                <i class="fas fa-plus mr-2"></i>Add Point
                            </button>
                            <button id="resetCalBtn" class="btn-secondary flex-1" disabled>
                                <i class="fas fa-trash mr-2"></i>Reset
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Calibration Status -->
                <div class="card p-6">
                    <h2 class="text-xl font-semibold mb-4">Calibration Status</h2>
                    <div class="space-y-4">
                        <div class="flex justify-between">
                            <span class="text-gray-600 dark:text-gray-400">Calibration Points:</span>
                            <span class="font-semibold" id="calPointsCount">0</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600 dark:text-gray-400">Slope:</span>
                            <span class="font-semibold" id="calSlope">1.00</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600 dark:text-gray-400">Offset:</span>
                            <span class="font-semibold" id="calOffset">0.00</span>
                        </div>
                        <div class="mt-4">
                            <label class="block text-sm font-medium mb-2">Current Raw Reading</label>
                            <div class="text-2xl font-bold text-blue-500" id="currentRaw">--</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Calibration Points List -->
            <div class="card p-6 mt-8">
                <h2 class="text-xl font-semibold mb-4">Calibration Points</h2>
                <div class="data-table">
                    <table>
                        <thead>
                            <tr>
                                <th>Raw pH</th>
                                <th>Actual pH</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="calibrationTableBody">
                            <tr>
                                <td colspan="3" class="text-center text-gray-500 dark:text-gray-400">No calibration points added</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Data Tab -->
        <div id="data" class="tab-content">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- Data Table -->
                <div class="card p-6">
                    <h2 class="text-xl font-semibold mb-4">Measurement Data</h2>
                    <div class="data-table">
                        <table>
                            <thead>
                                <tr>
                                    <th>Time (s)</th>
                                    <th>pH Value</th>
                                </tr>
                            </thead>
                            <tbody id="dataTableBody">
                                <tr>
                                    <td colspan="2" class="text-center text-gray-500 dark:text-gray-400">No data recorded</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Export Controls -->
                <div class="card p-6">
                    <h2 class="text-xl font-semibold mb-4">Export Data</h2>
                    <div class="space-y-4">
                        <div class="p-4 bg-blue-50 dark:bg-blue-900/20 rounded-lg">
                            <div class="text-sm text-blue-800 dark:text-blue-200 mb-2">
                                <i class="fas fa-info-circle mr-1"></i>
                                Export your measurement data in CSV format for analysis in spreadsheet applications.
                            </div>
                        </div>
                        <div class="space-y-2">
                            <button id="exportCSVBtn" class="btn-primary w-full" disabled>
                                <i class="fas fa-download mr-2"></i>Export as CSV
                            </button>
                            <button id="clearDataBtn" class="btn-secondary w-full" disabled>
                                <i class="fas fa-trash mr-2"></i>Clear All Data
                            </button>
                        </div>
                        <div class="text-sm text-gray-500 dark:text-gray-400">
                            <div>Total measurements: <span id="totalMeasurements">0</span></div>
                            <div>Last export: <span id="lastExport">Never</span></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Notification Container -->
    <div id="notificationContainer"></div>

    <script src="main.js"></script>
</body>
</html>